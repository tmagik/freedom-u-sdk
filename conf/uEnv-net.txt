# This is the sample uEnv.txt file for HiFive Unleashed U-boot
# The current convention (SUBJECT TO CHANGE) is that this file
# will be loaded from the first MSDOS(fat) GPT partition on the
# MMC card. 

bootargs=debug console=tty0 console=ttySIF0 root=/dev/mmcblk0p2

# To boot from partition 2 of an NVME drive (with a PCI iofpga,
# such as the MicroSemi expansion board, uncomment below:

#bootargs=debug console=tty0 console=ttySIF0 root=/dev/nvme0n1p2

# to boot an initramfs (buildroot or debian/etc) use this
setupchosen=run setupvml; run setupird

# to boot with straight to the root= parition, uncomment below
# so we do not set the ramdisk pointers
#setupchosen=run setupvml

# The FIT file to boot from
fitfile=hifiveu.fit
fdtfile=hifive-unleashed-a00.dtb
sbifile=fw_jump.bin
vmlfile=vmlinux.bin
irdfile=initramfs.cpio.gz

# The rest of this is mostly of interest to u-boot developers
# below much match what's in FIT (ugha)
sbiaddr=80000000
fdtaddr=88000000
vmladdr=80200000
irdaddr=82000000
# oh the hack.. use a large size.. ugh
irdsize=01000000
vmlsize=00800000
newfdt=f0000000

# override the u-boot default..
fileaddr=0xa0000000

# Use the FDT in the FIT image..
#setupfdt1=fdt addr ${fdtaddr}; fdt resize; fdt chosen; fdt move ${fdtaddr} ${newfdt}

#use FDT that came with uboot
#setupfdt1=fdt addr ${newfdt}; fdt resize; fdt chosen; fdt move ${fdtaddr} ${newfdt}

#Use fit image, but don't call fdt move  (TODO: understand later: old uboot was hardcoded)
setupfdt1=fdt addr ${fdtaddr}; fdt resize; fdt chosen

setupird=setexpr irdend ${irdaddr} + ${irdsize}; fdt set /chosen linux,initrd-start <0x0 0x${irdaddr}>; fdt set /chosen linux,initrd-end <0x0 0x${irdend}>
setupvml=setexpr vmlend ${vmladdr} + ${vmlsize}; fdt set /chosen riscv,kernel-start <0x0 0x${vmladdr}>; fdt set /chosen riscv,kernel-end <0x0 0x${vmlend}>

#setupfdt2=fdt set /chosen bootargs ${bootargs}; fdt print /chosen
setupfdt2=fdt print /chosen; fdt set /chosen bootargs "${bootargs}"; fdt set /firmware uboot,ver ${ver}; fdt print /chosen; echo "fdtcontroladdr="${fdtcontroladdr};

bootwait=setenv _delay ${bootdelay}; echo ${_delay}; while test ${_delay} > 0; do sleep 1; setexpr _delay ${_delay} - 1; echo ${_delay}; done

# this assumes ${fileaddr} is already set!!
#boot2=tftp ${fileaddr} ${fitfile}; bootm start ${fileaddr}; run setupfdt1; run setupchosen; run setupfdt2; bootm loados ${fileaddr}; echo "Booting kernel in"; run bootwait; go 80000000

boot2=tftp ${sbiaddr} ${sbifile}; tftp ${vmladdr} ${vmlfile}; tftp ${fdtaddr} ${fdtfile}; tftp ${irdaddr} ${irdfile}; run setupfdt1; run setupchosen; run setupfdt2; echo "Booting kernel in"; run bootwait; fdt addr; go 0x80000000
